<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
<div data-id="{{ block.id }}">
  {%- if block.settings.heading -%}
    <h2>{{ block.settings.heading }}</h2>
  {%- endif -%}
  {%- if block.settings.description -%}
    <p>{{ block.settings.description }}</p>
  {%- endif -%}
  {{block.settings.product | json}}
  {% if block.settings.product != empty %}
    <p>Your browser must support HTML5 FormData/XHR2</p>
    <p>I believe that there is still a per-file limit of 20MB.</p>
    <input type="file" multiple id="file-uploader-{{ block.id }}" name="customers_uploaded_files[]" />
  {% endif %}
</div>

{% comment %}
- uploadAsync = false then all images will go in 1 api with customers_uploaded_files as parameter
{% endcomment %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handling canvas background image upload
    jQuery("#file-uploader-{{ block.id }}").fileinput({
      uploadUrl: "/tools/custom_api?action=upload_file",
      uploadAsync: true,
      minFileCount: {{block.settings.min_file_count}},
      maxFileCount: {{block.settings.max_file_count}},
      minFileSize: {{block.settings.min_file_size}},
      maxFileSize: {{block.settings.max_file_size}},
      // Extra data that will be passed as data to the url/AJAX server
      uploadExtraData: function(previewId, index) {
        return {
          timestamp: new Date().toUTCString()
        }
      },
      overwriteInitial: false,
      initialPreviewAsData: true
    })
    .on('fileloaded', function(event, file, previewId, fileId, index, reader) {
      reader.readAsDataURL(file)
      reader.onload = function() {
        let fileContent = reader.result;
        // console.log(fileContent)
      }
      reader.onerror = function() {
        console.log(reader.error);
      }
    })
    .on('fileclear', function(event) {
      console.log("file cleared")
    })
    .on('filesorted', function(e, params) {
      console.log('file sorted', e, params);
    })
    .on('fileuploaded', function(event, data, previewId, index, fileId) {
        console.log('File Uploaded', event, data, previewId, index, fileId);
    })
    .on('fileuploaderror', function(event, data, msg) {
        console.log('File Upload Error', 'ID: ' + data.fileId + ', Thumb ID: ' + data.previewId);
    })
    .on('filebatchuploadcomplete', function(event, preview, config, tags, extraData) {
        console.log('File Batch Uploaded', event, preview, config, tags, extraData);
    });
  })
</script>


{% schema %}
  {
    "name": "User File Uploader",
    "target": "section",
    "stylesheet": "app-block.css",
    "javascript": "app-block-js-files.js",
    "class": "user_file_uploader_wrapper",
    "settings": [
      {
        "type": "text",
        "id": "heading",
        "label": "Heading",
        "default": "Upload Images To Product"
      },
      {
        "type": "text",
        "id": "description",
        "label": "Description",
        "default": "Upload your images and hit upload button to add to cart"
      },
      {
        "type": "select",
        "id": "allowedFileTypes",
        "label": "Allowed File Types",
        "options": [
          {
            "value": "image",
            "label": "Image"
          },
          {
            "value": "html",
            "label": "HTML"
          },
          {
            "value": "text",
            "label": "text"
          },
          {
            "value": "video",
            "label": "Video"
          },
          {
            "value": "audio",
            "label": "Audio"
          }
        ],
        "default": "image"
      },
      {
        "type": "product",
        "id": "product",
        "label": "Product",
        "info": "File drag & drop UI will only appear after you select a product"
      },
      {
        "type": "number",
        "id": "min_file_count",
        "label": "Minimum Number of files Required",
        "default": 0,
        "info": "Minimum number of files required for Add to cart> If set to 0, it means number of files are optional"
      },
      {
        "type": "number",
        "id": "max_file_count",
        "label": "Maximum Number of files",
        "default": 72,
        "info": "maximum number of files allowed for each multiple upload. If set to 0, it means number of files allowed is unlimited."
      },
      {
        "type": "number",
        "id": "min_file_size",
        "label": "Minimum file size for upload in KB",
        "default": 0,
        "info": "The file size must exceed the value set here, else a validation error is thrown using the msgSizeTooSmall setting. Defaults to 0. If this is set to null, then the validation is skipped and no minimum value check will be performed."
      },
      {
        "type": "number",
        "id": "max_file_size",
        "label": "Maximum file size for upload in KB",
        "default": 2000,
        "info": "If greater than this, a validation error is thrown using the msgSizeTooLarge setting. If set to 0, it means size allowed is unlimited. Defaults to 0."
      }
    ]
  }
{% endschema %}
